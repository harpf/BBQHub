@page "{id}"
@model BBQHub.Pages.Ranglisten.EventRanglisteModel
@{
    ViewData["Title"] = "Rangliste";
    var durchgaenge = Model.Durchgaenge;
    var streichAktiv = Model.Event?.EnableStreichresultate == true;
    var istSpontan = Model.IstSpontanEvent;
}

<h1 class="text-3xl font-bold text-orange-500 mb-6">🏆 Rangliste – @Model.Event?.Name</h1>

<!-- 📄 Export Gesamt -->
<div class="mb-6">
    <a class="bg-orange-600 text-white px-5 py-2 rounded-lg hover:bg-orange-700 shadow-md"
       href="/Ranglisten/Export?EventId=@Model.Id&Type=gesamt">
        📄 Gesamt-Rangliste als PDF exportieren
    </a>
</div>

<!-- 🧮 Gesamt-Rangliste -->
<div class="overflow-x-auto mb-12">
    <table class="min-w-full text-sm text-left border-collapse bg-zinc-800 text-white shadow-lg rounded">
        <thead class="bg-zinc-700 text-white uppercase text-xs tracking-wide">
            <tr>
                <th class="p-3">Platz</th>
                <th class="p-3">@((istSpontan ? "Teilnehmer" : "Team"))</th>
                @foreach (var dg in durchgaenge)
                {
                    <th class="p-3">Durchgang @dg.Durchgangsnummer</th>
                }
                <th class="p-3">
                    Gesamt
                    @if (streichAktiv)
                    {
                        <span class="text-green-400" title="Beste & schlechteste Note ignoriert">(Streich)</span>
                    }
                </th>
            </tr>
        </thead>
        <tbody>
            @foreach (var eintrag in Model.Teams
            .OrderByDescending(t => streichAktiv
            ? Model.GesamtMitStreichresultat[t.Id]
            : Model.Gesamtpunkte[t.Id])
            .Select((t, index) => new { Team = t, Platz = index + 1 }))
            {
                <tr class="border-b border-zinc-700 hover:bg-zinc-900 transition">
                    <td class="p-3 font-bold">@eintrag.Platz</td>
                    <td class="p-3 font-semibold">
                        @(istSpontan
                            ? Model.TeilnehmerNamen.GetValueOrDefault(eintrag.Team.Id, "Unbekannt")
                            : eintrag.Team.Name)
                    </td>
                    @foreach (var dg in durchgaenge)
                    {
                        var normal = Model.PunkteProDurchgang[eintrag.Team.Id].GetValueOrDefault(dg.Id);
                        var mitStreich = streichAktiv
                        ? Model.PunkteMitStreichresultat[eintrag.Team.Id].GetValueOrDefault(dg.Id)
                        : 0;

                        <td class="p-3">
                            @normal.ToString("0.0")
                            @if (streichAktiv)
                            {
                                <span class="text-green-400 text-xs ml-1">(@mitStreich.ToString("0.0"))</span>
                            }
                        </td>
                    }
                    <td class="p-3 font-bold @(streichAktiv ? "text-green-400" : "text-orange-400")">
                        @((streichAktiv
                            ? Model.GesamtMitStreichresultat[eintrag.Team.Id]
                            : Model.Gesamtpunkte[eintrag.Team.Id]).ToString("0.0"))
                    </td>
                </tr>
            }
        </tbody>
    </table>
</div>

<!-- 📊 Einzelne Durchgänge -->
@foreach (var dg in durchgaenge)
{
    var kriterien = dg.Kriterien;

    <div class="mb-10">
        <div class="flex justify-between items-center mb-3">
            <h2 class="text-xl font-semibold text-orange-400">
                Durchgang @dg.Durchgangsnummer: @dg.Name
            </h2>
            <a class="bg-orange-600 text-white px-4 py-2 text-sm rounded hover:bg-orange-700"
               href="/Ranglisten/Export?EventId=@Model.Id&DurchgangId=@dg.Id&Type=durchgang">
                📄 Exportieren
            </a>
        </div>

        <div class="overflow-x-auto">
            <table class="min-w-full text-sm text-center border-collapse bg-zinc-800 text-white shadow-md rounded">
                <thead class="bg-zinc-700">
                    <tr>
                        <th class="p-2" align="left">Platz</th>
                        <th class="p-2" align="left">@((istSpontan ? "Teilnehmer" : "Team"))</th>
                        @foreach (var kriterium in kriterien)
                        {
                            <th class="p-2">@kriterium.Name</th>
                        }
                        <th class="p-2">Gesamt</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var item in Model.Teams
                   .OrderByDescending(t => streichAktiv
                   ? Model.PunkteMitStreichresultat[t.Id].GetValueOrDefault(dg.Id)
                   : Model.PunkteProDurchgang[t.Id].GetValueOrDefault(dg.Id))
                   .Select((t, index) => new { Team = t, Platz = index + 1 }))
                    {
                        var teamId = item.Team.Id;
                        var auswertungen = Model.KriteriumAuswertungen.GetValueOrDefault((teamId, dg.Id));

                        <tr class="border-b border-zinc-700 hover:bg-zinc-900 transition">
                            <td class="p-2 font-bold" align="left">@item.Platz</td>
                            <td class="p-2 font-semibold" align="left">
                                @(istSpontan
                                    ? Model.TeilnehmerNamen.GetValueOrDefault(teamId, "Unbekannt")
                                    : item.Team.Name)
                            </td>
                            @foreach (var kriterium in kriterien)
                            {
                                var auswertung = auswertungen?.FirstOrDefault(k => k.KriteriumName == kriterium.Name);
                                <td class="p-2">
                                    @if (auswertung != null)
                                    {
                                        <div>
                                            <div class="text-white font-medium">@auswertung.VergebenePunkte</div>
                                        </div>
                                    }
                                    else
                                    {
                                        <span class="text-zinc-500 italic text-sm">–</span>
                                    }
                                </td>
                            }
                            <td class="p-2 font-semibold text-orange-300">
                                @Model.PunkteProDurchgang[teamId].GetValueOrDefault(dg.Id).ToString("0.0")
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>
}